name: Build Multi-Platform Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        required: false
        default: true
        type: boolean
      build_macos:
        description: 'Build macOS'
        required: false
        default: true
        type: boolean
      build_linux:
        description: 'Build Linux'
        required: false
        default: false
        type: boolean

jobs:
  # Windows æ„å»º
  build-windows:
    if: github.event.inputs.build_windows != 'false'
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.4'
        channel: 'stable'
        cache: true
        
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
      
    - name: Install dependencies
      run: flutter pub get

    - name: Analyze code (optional)
      run: flutter analyze || true
      continue-on-error: true

    - name: Prepare Windows assets
      run: |
        # åªä¿ç•™ Windows å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
        Remove-Item -Path "assets/bin/N_m3u8DL-RE" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "assets/bin/ffmpeg" -Force -ErrorAction SilentlyContinue
        Write-Host "Windows assets prepared - keeping .exe files only"
      shell: powershell

    - name: Build Windows Release
      run: flutter build windows --release --verbose

    - name: Debug - List Windows build directory structure
      run: |
        Write-Host "Listing build directory structure:"
        if (Test-Path "build") {
          Get-ChildItem -Path "build" -Recurse -Directory | Select-Object FullName
          Write-Host "Looking for executable files:"
          Get-ChildItem -Path "build" -Recurse -Filter "*.exe" | Select-Object FullName
        } else {
          Write-Host "Build directory does not exist"
        }
      shell: powershell

    - name: Install NSIS
      run: |
        # Download and install NSIS
        Invoke-WebRequest -Uri "https://downloads.sourceforge.net/project/nsis/NSIS%203/3.09/nsis-3.09-setup.exe" -OutFile "nsis-setup.exe"
        Start-Process -FilePath "nsis-setup.exe" -ArgumentList "/S" -Wait
        # Add NSIS to PATH
        $env:PATH += ";C:\Program Files (x86)\NSIS"
        echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell

    - name: Create NSIS installer script
      run: |
        $nsisScript = @"
        !define APP_NAME "Shiplus"
        !define APP_VERSION "1.0.0"
        !define APP_PUBLISHER "Shiplus Team"
        !define APP_URL "https://github.com/your-repo/shiplus"
        !define APP_DESCRIPTION "Shiplus - F1 Video Downloader"

        # Installer settings
        Name "`${APP_NAME}"
        OutFile "shiplus-windows-x64-installer.exe"
        InstallDir "`$PROGRAMFILES64\`${APP_NAME}"
        InstallDirRegKey HKLM "Software\`${APP_NAME}" "InstallDir"
        RequestExecutionLevel admin

        # Modern UI
        !include "MUI2.nsh"
        !define MUI_ABORTWARNING
        !define MUI_ICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
        !define MUI_UNICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"

        # Pages
        !insertmacro MUI_PAGE_WELCOME
        !insertmacro MUI_PAGE_LICENSE "LICENSE"
        !insertmacro MUI_PAGE_DIRECTORY
        !insertmacro MUI_PAGE_INSTFILES
        !insertmacro MUI_PAGE_FINISH

        !insertmacro MUI_UNPAGE_WELCOME
        !insertmacro MUI_UNPAGE_CONFIRM
        !insertmacro MUI_UNPAGE_INSTFILES
        !insertmacro MUI_UNPAGE_FINISH

        # Languages
        !insertmacro MUI_LANGUAGE "English"
        !insertmacro MUI_LANGUAGE "SimpChinese"

        # Version info
        VIProductVersion "1.0.0.0"
        VIAddVersionKey "ProductName" "`${APP_NAME}"
        VIAddVersionKey "ProductVersion" "`${APP_VERSION}"
        VIAddVersionKey "CompanyName" "`${APP_PUBLISHER}"
        VIAddVersionKey "FileDescription" "`${APP_DESCRIPTION}"
        VIAddVersionKey "FileVersion" "`${APP_VERSION}"

        # Installer sections
        Section "MainSection" SEC01
          SetOutPath "`$INSTDIR"
          SetOverwrite ifnewer

          # Copy all files from build directory
          File /r "build\windows\x64\runner\Release\*"

          # Create uninstaller
          WriteUninstaller "`$INSTDIR\uninstall.exe"

          # Registry entries
          WriteRegStr HKLM "Software\`${APP_NAME}" "InstallDir" "`$INSTDIR"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayName" "`${APP_NAME}"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "UninstallString" "`$INSTDIR\uninstall.exe"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayIcon" "`$INSTDIR\shiplus.exe"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "Publisher" "`${APP_PUBLISHER}"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayVersion" "`${APP_VERSION}"
          WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "NoModify" 1
          WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "NoRepair" 1
        SectionEnd

        # Desktop shortcut
        Section "Desktop Shortcut" SEC02
          CreateShortCut "`$DESKTOP\`${APP_NAME}.lnk" "`$INSTDIR\shiplus.exe"
        SectionEnd

        # Start menu shortcut
        Section "Start Menu Shortcut" SEC03
          CreateDirectory "`$SMPROGRAMS\`${APP_NAME}"
          CreateShortCut "`$SMPROGRAMS\`${APP_NAME}\`${APP_NAME}.lnk" "`$INSTDIR\shiplus.exe"
          CreateShortCut "`$SMPROGRAMS\`${APP_NAME}\Uninstall.lnk" "`$INSTDIR\uninstall.exe"
        SectionEnd

        # Uninstaller
        Section "Uninstall"
          Delete "`$INSTDIR\uninstall.exe"
          RMDir /r "`$INSTDIR"

          DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}"
          DeleteRegKey HKLM "Software\`${APP_NAME}"

          Delete "`$DESKTOP\`${APP_NAME}.lnk"
          Delete "`$SMPROGRAMS\`${APP_NAME}\*.*"
          RMDir "`$SMPROGRAMS\`${APP_NAME}"
        SectionEnd
        "@

        $nsisScript | Out-File -FilePath "installer.nsi" -Encoding UTF8
        Write-Host "NSIS script created"
      shell: powershell

    - name: Create LICENSE file for installer
      run: |
        $license = @"
        MIT License

        Copyright (c) 2024 Shiplus Team

        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:

        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        "@

        $license | Out-File -FilePath "LICENSE" -Encoding UTF8
        Write-Host "LICENSE file created"
      shell: powershell

    - name: Build Windows installer
      run: |
        # Build the installer using NSIS
        makensis installer.nsi
        Write-Host "Windows installer created"
      shell: powershell

    - name: Create Windows release package
      run: |
        # Find the exe file and its directory
        $exeFile = Get-ChildItem -Path "build" -Recurse -Filter "shiplus.exe" | Select-Object -First 1
        if ($exeFile) {
          Write-Host "Found exe at: $($exeFile.FullName)"
          $releaseDir = $exeFile.Directory.FullName
          Write-Host "Release directory: $releaseDir"

          # Create archive from the directory containing the exe
          Set-Location $releaseDir
          $archivePath = Join-Path $env:GITHUB_WORKSPACE "shiplus-windows-x64.zip"
          7z a -tzip $archivePath *
          Write-Host "Created archive: $archivePath"
        } else {
          Write-Host "ERROR: Could not find shiplus.exe"
          exit 1
        }
      shell: powershell
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shiplus-windows-x64
        path: |
          shiplus-windows-x64.zip
          shiplus-windows-x64-installer.exe
        retention-days: 30

  # macOS æ„å»º
  build-macos:
    if: github.event.inputs.build_macos != 'false'
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.4'
        channel: 'stable'
        cache: true
        
    - name: Enable macOS desktop
      run: flutter config --enable-macos-desktop
      
    - name: Install dependencies
      run: flutter pub get

    - name: Analyze code (optional)
      run: flutter analyze || true
      continue-on-error: true

    - name: Prepare macOS assets
      run: |
        # åªä¿ç•™ macOS å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
        rm -f assets/bin/N_m3u8DL-RE.exe
        rm -f assets/bin/ffmpeg.exe
        echo "macOS assets prepared - keeping non-.exe files only"

    - name: Build macOS Release (Apple Silicon)
      run: flutter build macos --release --verbose

    - name: Create macOS release package
      run: |
        cd build/macos/Build/Products/Release
        zip -r ../../../../../shiplus-macos-arm64.zip shiplus.app

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shiplus-macos-arm64
        path: shiplus-macos-arm64.zip
        retention-days: 30

  # Linux æ„å»º
  build-linux:
    if: github.event.inputs.build_linux == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.4'
        channel: 'stable'
        cache: true
        
    - name: Enable Linux desktop
      run: flutter config --enable-linux-desktop
      
    - name: Install dependencies
      run: flutter pub get

    - name: Analyze code (optional)
      run: flutter analyze || true
      continue-on-error: true

    - name: Prepare Linux assets
      run: |
        # åªä¿ç•™ Linux å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸ macOS ç›¸åŒï¼Œæ—  .exe åç¼€ï¼‰
        rm -f assets/bin/N_m3u8DL-RE.exe
        rm -f assets/bin/ffmpeg.exe
        echo "Linux assets prepared - keeping non-.exe files only"

    - name: Build Linux Release
      run: flutter build linux --release --verbose
      
    - name: Create Linux release package
      run: |
        cd build/linux/x64/release/bundle
        tar -czf ../../../../../shiplus-linux-x64.tar.gz *
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shiplus-linux-x64
        path: shiplus-linux-x64.tar.gz
        retention-days: 30

  # åˆ›å»º GitHub Release
  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          shiplus-windows-x64/shiplus-windows-x64.zip
          shiplus-windows-x64/shiplus-windows-x64-installer.exe
          shiplus-macos-arm64/shiplus-macos-arm64.zip
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ Shiplus ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          #### Windows (x64)
          **æ¨èå®‰è£…æ–¹å¼ï¼š**
          - ä¸‹è½½: `shiplus-windows-x64-installer.exe`
          - åŒå‡»è¿è¡Œå®‰è£…ç¨‹åºï¼ŒæŒ‰æç¤ºå®Œæˆå®‰è£…
          - è‡ªåŠ¨åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å’Œå¼€å§‹èœå•é¡¹ç›®

          **ä¾¿æºç‰ˆï¼š**
          - ä¸‹è½½: `shiplus-windows-x64.zip`
          - è§£å‹åè¿è¡Œ `shiplus.exe`
          - æ— éœ€å®‰è£…ï¼Œå¯æ”¾ç½®åœ¨ä»»æ„æ–‡ä»¶å¤¹

          - ç³»ç»Ÿè¦æ±‚: Windows 10+ (x64)

          #### macOS (Apple Silicon)
          - ä¸‹è½½: `shiplus-macos-arm64.zip`
          - è§£å‹åè¿è¡Œ `shiplus.app`
          - ç³»ç»Ÿè¦æ±‚: macOS 11.0+ (M1/M2/M3 èŠ¯ç‰‡)

          ### ğŸ”§ å®‰è£…æ­¥éª¤

          #### Windows ç”¨æˆ·
          1. **å®‰è£…ç‰ˆï¼ˆæ¨èï¼‰**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼ŒåŒå‡»è¿è¡Œå¹¶æŒ‰æç¤ºå®‰è£…
          2. **ä¾¿æºç‰ˆ**: ä¸‹è½½ `.zip` å‹ç¼©åŒ…ï¼Œè§£å‹åˆ°ä»»æ„æ–‡ä»¶å¤¹ï¼Œè¿è¡Œ `shiplus.exe`

          #### macOS ç”¨æˆ·
          1. ä¸‹è½½ `.zip` å‹ç¼©åŒ…
          2. è§£å‹åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. è¿è¡Œ `shiplus.app`

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - Windows ç”¨æˆ·é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸åº”ç”¨ç¨‹åºé€šè¿‡é˜²ç«å¢™
          - macOS ç”¨æˆ·å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸åº”ç”¨è¿è¡Œ
          - å®‰è£…ç‰ˆä¼šè‡ªåŠ¨åˆ›å»ºå¸è½½ç¨‹åºï¼Œå¯é€šè¿‡æ§åˆ¶é¢æ¿å¸è½½
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
